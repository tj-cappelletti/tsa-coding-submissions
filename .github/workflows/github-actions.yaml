name: build-application-workflow

# Build on every push (regardless of branch)
# Build on PR to ensure the merge is good
# Allow manual builds
on: [push, pull_request, workflow_dispatch]

env:
  DOCKER_REPO: webstorm.azurecr.io

jobs:
  semver:
    name: "Generate SemVer"
    runs-on: ubuntu-latest
    outputs:
      major: ${{ steps.gitversion.outputs.major }}
      minor: ${{ steps.gitversion.outputs.minor }}
      patch: ${{ steps.gitversion.outputs.patch }}
      majorMinor: ${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}
      semVer: ${{ steps.gitversion.outputs.semver }}
      shorSha: ${{ steps.gitversion.outputs.shortSha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.7
        with:
          versionSpec: '5.x'
        
      - name: GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.7
    
  buildApplciations:
    name: "Build .NET Applciations"
    needs: semver
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.301

      - name: Restore Web API Project
        run: dotnet restore ./src/Tsa.CodingChallenge.Submissions.WebApi/Tsa.CodingChallenge.Submissions.WebApi.csproj

      - name: Restore Blazor Project
        run: dotnet restore ./src/Tsa.CodingChallenge.Submissions.Blazor/Tsa.CodingChallenge.Submissions.Blazor.csproj

      - name: Restore Unit Tests Project
        run: dotnet restore ./src/Tsa.CodingChallenge.Submissions.UnitTests/Tsa.CodingChallenge.Submissions.UnitTests.csproj

      - name: Build Web API Project
        run: dotnet build ./src/Tsa.CodingChallenge.Submissions.WebApi/Tsa.CodingChallenge.Submissions.WebApi.csproj --configuration Release --no-restore --nologo

      - name: Build Blazor Project
        run: dotnet build ./src/Tsa.CodingChallenge.Submissions.Blazor/Tsa.CodingChallenge.Submissions.Blazor.csproj --configuration Release --no-restore --nologo
        
      - name: Run Unit Tests
        run: dotnet test ./src/Tsa.CodingChallenge.Submissions.UnitTests/Tsa.CodingChallenge.Submissions.UnitTests.csproj --no-restore --verbosity normal --filter "TestCategory=UnitTest" --nologo

      - name: Publish Blazor App
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        run: |
          dotnet publish ./src/Tsa.CodingChallenge.Submissions.Blazor/Tsa.CodingChallenge.Submissions.Blazor.csproj \
            --configuration Release \
            --no-build \
            --output ${{ runner.temp }}/Tsa.CodingChallenge.Submissions.Blazor \
            --nologo

      - name: Publish Web AIP
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        run: |
          dotnet publish ./src/Tsa.CodingChallenge.Submissions.WebApi/Tsa.CodingChallenge.Submissions.WebApi.csproj \
            --configuration Release \
            --no-build \
            --output ${{ runner.temp }}/Tsa.CodingChallenge.Submissions.WebApi \
            --nologo

      - uses: actions/upload-artifact@v2
        name: Upload Published Blazor Web App
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        with:
          name: web-api
          path: ${{ runner.temp }}/Tsa.CodingChallenge.Submissions.Blazor
        
      - uses: actions/upload-artifact@v2
        name: Upload Published Web API App
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        with:
          name: web-api
          path: ${{ runner.temp }}/Tsa.CodingChallenge.Submissions.WebApi

  buildDatabase:
    name: "Build Database DACPAC"
    needs: semver
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Build Database DACPAC
        run: |
          msbuild src\Tsa.CodingChallenge.Submissions.Database\Tsa.CodingChallenge.Submissions.Database.sqlproj `
            /t:Build `
            /p:configuration=release `
            /p:SolutionDir=${{ github.workspace }}\src\
      
      # This needs to run in the build step to ensure we've captured
      # the Dockerfile and the creation script as this can't run on
      # a Linux VM - Microsoft needs to make MSBuild work on Linux
      - uses: actions/upload-artifact@v2
        name: Upload Docker Artifacts
        # DEBUG ONLY - Commented out condition to test workflow
        #if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        with:
          name: database-docker
          path: src/docker/database

      - uses: actions/upload-artifact@v2
        name: Upload DACPAC Artifact
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        with:
          name: database-dacpac
          path: src/*.Database/**/*.dacpac

  # TODO: Only run on master branch  
  buildDockerContainers:
    name: Build Docker Containers
    needs: [semver, buildApplciations, buildDatabase]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: [blazor, database, webapi]
        include:
          - image: blazor
            downloadArtifacts: false
            dockerContext: src/
            dockerfile: src/Tsa.CodingChallenge.Submissions.Blazor/Dockerfile
          - image: database
            downloadArtifacts: true
            dockerContext: database-docker/
            dockerfile: database-docker/Dockerfile
          - image: webapi
            downloadArtifacts: false
            dockerContext: src/
            dockerfile: src/Tsa.CodingChallenge.Submissions.WebApi/Dockerfile
    steps:
      - uses: actions/checkout@v2

      - uses: actions/download-artifact@v2
        if: ${{ matrix.downloadArtifacts == true }}
        with:
          name: database-docker
          path: database-docker/
          
      - name: Set Execute on Scripts
        if: ${{ matrix.downloadArtifacts == true }}
        run: chmod a+x ./database-docker/scripts/create-sql-database.sh

      - name: Build tsa/coding/submissions/${{ matrix.image }} Image
        run: |
          docker build \
            --tag $DOCKER_REPO/tsa/coding/submissions/${{ matrix.image }}:${{ needs.semver.outputs.semVer }} \
            --tag $DOCKER_REPO/tsa/coding/submissions/${{ matrix.image }}:${{ needs.semver.outputs.majorMinor }} \
            --tag $DOCKER_REPO/tsa/coding/submissions/${{ matrix.image }}:${{ needs.semver.outputs.major }} \
            --file ${{ matrix.dockerfile }} \
            ${{ matrix.dockerContext }}

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_ACR_CREDENTIALS }}

      - name: Push tsa/coding/submissions/${{ matrix.image }} Image
        uses: azure/docker-login@v1
        with:
          login-server: $DOCKER_REPO
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
        run: |
          docker push $DOCKER_REPO/tsa/coding/submissions/${{ matrix.image }}:${{ needs.semver.outputs.semVer }}
          docker push $DOCKER_REPO/tsa/coding/submissions/${{ matrix.image }}:${{ needs.semver.outputs.majorMinor }}
          docker push $DOCKER_REPO/tsa/coding/submissions/${{ matrix.image }}:${{ needs.semver.outputs.major }}
